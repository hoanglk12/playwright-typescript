version: 2.1

orbs:
  node: circleci/node@5.1.0
  windows: circleci/windows@5.0.0

parameters:
  environment:
    type: enum
    enum: ["testing", "staging", "production"]
    default: "testing"
  mode:
    type: enum
    enum: ["parallel", "serial"]
    default: "parallel"
  workers:
    type: string
    default: "4"
  browser:
    type: enum
    enum: ["all", "chromium", "firefox", "webkit"]
    default: "all"
  test_type:
    type: enum
    enum: ["both", "ui", "api"]
    default: "both"

executors:
  linux-executor:
    docker:
      - image: mcr.microsoft.com/playwright:v1.40.0-focal
    working_directory: ~/project
    environment:
      NODE_ENV: << pipeline.parameters.environment >>
      TEST_ENV: << pipeline.parameters.environment >>
      TEST_MODE: << pipeline.parameters.mode >>
      TEST_WORKERS: << pipeline.parameters.workers >>
      TEST_BROWSER: << pipeline.parameters.browser >>
      TEST_TYPE: << pipeline.parameters.test_type >>

  windows-executor:
    executor:
      name: windows/default
      shell: cmd.exe
    working_directory: ~/project
    environment:
      NODE_ENV: << pipeline.parameters.environment >>
      TEST_ENV: << pipeline.parameters.environment >>
      TEST_MODE: << pipeline.parameters.mode >>
      TEST_WORKERS: << pipeline.parameters.workers >>
      TEST_BROWSER: << pipeline.parameters.browser >>
      TEST_TYPE: << pipeline.parameters.test_type >>

  macos-executor:
    macos:
      xcode: 15.0.0
    working_directory: ~/project
    environment:
      NODE_ENV: << pipeline.parameters.environment >>
      TEST_ENV: << pipeline.parameters.environment >>
      TEST_MODE: << pipeline.parameters.mode >>
      TEST_WORKERS: << pipeline.parameters.workers >>
      TEST_BROWSER: << pipeline.parameters.browser >>
      TEST_TYPE: << pipeline.parameters.test_type >>

commands:
  install-dependencies:
    description: "Install Node.js dependencies"
    steps:
      - checkout
      - node/install:
          node-version: '20'
      - restore_cache:
          keys:
            - v1-dependencies-{{ arch }}-{{ checksum "package-lock.json" }}
            - v1-dependencies-{{ arch }}-
      - run:
          name: Install dependencies
          command: npm ci
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ arch }}-{{ checksum "package-lock.json" }}

  cache-playwright-browsers:
    description: "Cache Playwright browsers"
    steps:
      - restore_cache:
          keys:
            - v1-playwright-browsers-{{ arch }}-{{ checksum "package-lock.json" }}
            - v1-playwright-browsers-{{ arch }}-
      - run:
          name: Install Playwright Browsers
          command: npx playwright install --with-deps
      - save_cache:
          paths:
            - ~/.cache/ms-playwright
            - ~/Library/Caches/ms-playwright
          key: v1-playwright-browsers-{{ arch }}-{{ checksum "package-lock.json" }}

  make-scripts-executable:
    description: "Make test scripts executable"
    steps:
      - run:
          name: Make scripts executable
          command: |
            chmod +x ./run-ui-tests.sh
            chmod +x ./run-api-tests-nonparallel.sh

  display-test-config:
    description: "Display test configuration"
    steps:
      - run:
          name: Display test configuration
          command: |
            echo "Test Environment: $TEST_ENV"
            echo "Test Mode: $TEST_MODE"
            echo "Workers: $TEST_WORKERS"
            echo "Browser: $TEST_BROWSER"
            echo "Test Type: $TEST_TYPE"

jobs:
  ui-test-linux:
    executor: linux-executor
    steps:
      - install-dependencies
      - cache-playwright-browsers
      - make-scripts-executable
      - display-test-config
      - run:
          name: Run UI tests (Linux)
          command: ./run-ui-tests.sh $TEST_ENV $TEST_MODE $TEST_WORKERS
          environment:
            BROWSER: << pipeline.parameters.browser >>
          no_output_timeout: 45m
      - store_artifacts:
          path: test-results/
          destination: ui-test-results-linux-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_artifacts:
          path: playwright-report/
          destination: ui-test-results-linux-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_artifacts:
          path: screenshots/
          destination: ui-test-results-linux-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_artifacts:
          path: videos/
          destination: ui-test-results-linux-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_test_results:
          path: test-results/

  ui-test-windows:
    executor: windows-executor
    steps:
      - checkout
      - run:
          name: Install Node.js
          command: |
            choco install nodejs --version=20.10.0 -y
            refreshenv
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: Install Playwright Browsers
          command: npx playwright install --with-deps
      - display-test-config
      - run:
          name: Run UI tests (Windows)
          command: ./run-ui-tests.bat %TEST_ENV% %TEST_MODE% %TEST_WORKERS%
          environment:
            BROWSER: << pipeline.parameters.browser >>
          no_output_timeout: 45m
      - store_artifacts:
          path: test-results/
          destination: ui-test-results-windows-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_artifacts:
          path: playwright-report/
          destination: ui-test-results-windows-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_artifacts:
          path: screenshots/
          destination: ui-test-results-windows-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_artifacts:
          path: videos/
          destination: ui-test-results-windows-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>

  ui-test-macos:
    executor: macos-executor
    steps:
      - install-dependencies
      - cache-playwright-browsers
      - make-scripts-executable
      - display-test-config
      - run:
          name: Run UI tests (macOS)
          command: ./run-ui-tests.sh $TEST_ENV $TEST_MODE $TEST_WORKERS
          environment:
            BROWSER: << pipeline.parameters.browser >>
          no_output_timeout: 45m
      - store_artifacts:
          path: test-results/
          destination: ui-test-results-macos-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_artifacts:
          path: playwright-report/
          destination: ui-test-results-macos-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_artifacts:
          path: screenshots/
          destination: ui-test-results-macos-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>
      - store_artifacts:
          path: videos/
          destination: ui-test-results-macos-<< pipeline.parameters.environment >>-<< pipeline.parameters.mode >>

  api-test:
    executor: linux-executor
    steps:
      - install-dependencies
      - make-scripts-executable
      - run:
          name: Display API test configuration
          command: |
            echo "API Test Environment: $TEST_ENV"
            echo "API Base URL: ${API_BASE_URL:-'https://restful-booker.herokuapp.com'}"
            echo "Execution: Serial (1 worker)"
      - run:
          name: Run API tests
          command: ./run-api-tests-nonparallel.sh
          environment:
            API_ENV: << pipeline.parameters.environment >>
          no_output_timeout: 30m
      - store_artifacts:
          path: test-results/api/
          destination: api-test-results-<< pipeline.parameters.environment >>
      - store_artifacts:
          path: api-results/
          destination: api-test-results-<< pipeline.parameters.environment >>
      - store_artifacts:
          path: api-report/
          destination: api-test-results-<< pipeline.parameters.environment >>
      - store_artifacts:
          path: playwright-report/
          destination: api-test-results-<< pipeline.parameters.environment >>
      - store_test_results:
          path: test-results/api/

  test-report:
    executor: linux-executor
    steps:
      - checkout
      - run:
          name: Create combined results directory
          command: mkdir -p ./combined-results/{ui,api}
      - run:
          name: Generate combined report
          command: |
            mkdir -p ./combined-report
            cat > ./combined-report/index.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head>
                <title>Test Results</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .config { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0; }
                    .results { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 20px 0; }
                    ul { margin: 10px 0; }
                    li { margin: 5px 0; }
                </style>
            </head>
            <body>
                <h1>ðŸŽ­ Playwright Test Results</h1>
                <div class="config">
                    <h2>Test Configuration</h2>
                    <ul>
                        <li>Environment: << pipeline.parameters.environment >></li>
                        <li>Mode: << pipeline.parameters.mode >></li>
                        <li>Workers: << pipeline.parameters.workers >></li>
                        <li>Browser: << pipeline.parameters.browser >></li>
                        <li>Test Type: << pipeline.parameters.test_type >></li>
                        <li>Timestamp: $(date)</li>
                    </ul>
                </div>
                <div class="results">
                    <h2>Test Results</h2>
                    <p>UI and API tests completed. Check CircleCI artifacts for detailed reports.</p>
                    <ul>
                        <li>Screenshots and videos available in artifacts</li>
                        <li>HTML reports with detailed test information</li>
                        <li>Test results in JUnit format</li>
                    </ul>
                </div>
                <div class="results">
                    <h2>Artifacts</h2>
                    <ul>
                        <li>Test results are available in the CircleCI artifacts section</li>
                        <li>Reports include screenshots, videos, and HTML reports</li>
                        <li>Retention period: 30 days</li>
                    </ul>
                </div>
            </body>
            </html>
            EOF
      - store_artifacts:
          path: ./combined-report/
          destination: combined-test-report-<< pipeline.parameters.environment >>

  notify-results:
    executor: linux-executor
    steps:
      - run:
          name: Generate notification summary
          command: |
            echo "ðŸŽ­ Playwright Test Results Summary"
            echo "================================="
            echo "Environment: << pipeline.parameters.environment >>"
            echo "Mode: << pipeline.parameters.mode >>"
            echo "Workers: << pipeline.parameters.workers >>"
            echo "Browser: << pipeline.parameters.browser >>"
            echo "Test Type: << pipeline.parameters.test_type >>"
            echo "Pipeline: $CIRCLE_BUILD_URL"
            echo "Build Number: $CIRCLE_BUILD_NUM"
            echo "Branch: $CIRCLE_BRANCH"
            echo "================================="

workflows:
  version: 2
  playwright-tests:
    jobs:
      # UI Tests - only run if test_type is not 'api'
      - ui-test-linux:
          filters:
            branches:
              only: [main, master, develop]
          context: playwright-testing

      - ui-test-windows:
          filters:
            branches:
              only: [main, master, develop]
          context: playwright-testing

      - ui-test-macos:
          filters:
            branches:
              only: [main, master, develop]
          context: playwright-testing

      # API Tests - only run if test_type is not 'ui'
      - api-test:
          filters:
            branches:
              only: [main, master, develop]
          context: playwright-testing

      # Generate combined report
      - test-report:
          requires:
            - ui-test-linux
            - ui-test-windows
            - ui-test-macos
            - api-test
          filters:
            branches:
              only: [main, master, develop]

      # Notify results
      - notify-results:
          requires:
            - test-report
          filters:
            branches:
              only: [main, master, develop]

  # Nightly tests workflow
  nightly-tests:
    triggers:
      - schedule:
          cron: "0 2 * * *"  # Run at 2 AM UTC daily
          filters:
            branches:
              only: [main, master]
    jobs:
      - ui-test-linux:
          context: playwright-testing
      - ui-test-windows:
          context: playwright-testing
      - ui-test-macos:
          context: playwright-testing
      - api-test:
          context: playwright-testing
      - test-report:
          requires:
            - ui-test-linux
            - ui-test-windows
            - ui-test-macos
            - api-test
      - notify-results:
          requires:
            - test-report

  # Manual trigger workflow for specific environments
  manual-trigger:
    when:
      and:
        - equal: [ scheduled_pipeline, false ]
        - equal: [ webhook, << pipeline.trigger_source >> ]
    jobs:
      - ui-test-linux:
          context: playwright-testing
      - ui-test-windows:
          context: playwright-testing
      - ui-test-macos:
          context: playwright-testing
      - api-test:
          context: playwright-testing
      - test-report:
          requires:
            - ui-test-linux
            - ui-test-windows
            - ui-test-macos
            - api-test
      - notify-results:
          requires:
            - test-report